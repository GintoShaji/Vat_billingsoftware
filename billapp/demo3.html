from django.shortcuts import render
from datetime import datetime
from collections import defaultdict
from django.db.models import Sum
from .models import DebitNote, PurchaseBill, Company, CustomUser

def Purchasereport_graph(request):
    if request.user.is_authenticated:
        user = request.user
        company = Company.objects.get(user=user)
        current_year = datetime.now().year

        # Purchase Report
        monthly_purchase_data = defaultdict(int)
        for month in range(1, 13):
            monthly_purchase_data[month] = (
                PurchaseBill.objects
                .filter(billdate__month=month, billdate__year=current_year, company=company)
                .aggregate(total_purchase=Sum('grandtotal'))['total_purchase'] or 0
            )

        yearly_purchase_data = defaultdict(int)
        for year in range(2022, current_year + 1):
            yearly_purchase_data[year] = (
                PurchaseBill.objects
                .filter(billdate__year=year, company=company)
                .aggregate(total_purchase=Sum('grandtotal'))['total_purchase'] or 0
            )

        month_names = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']
        monthly_purchase_labels = [f"{month_names[month - 1]} {current_year}" for month in range(1, 13)]
        monthly_purchase = [monthly_purchase_data[month] for month in range(1, 13)]

        yearly_purchase_labels = [str(year) for year in range(2014, current_year + 1)]
        yearly_purchase = [yearly_purchase_data[year] for year in range(2014, current_year + 1)]

        # Debit Note Report
        monthly_debit_data = defaultdict(int)
        for month in range(1, 13):
            monthly_debit_data[month] = (
                DebitNote.objects
                .filter(created_at__month=month, created_at__year=current_year, company=company)
                .aggregate(total_debit=Sum('grandtotal'))['total_debit'] or 0
            )

        yearly_debit_data = defaultdict(int)
        for year in range(2022, current_year + 1):
            yearly_debit_data[year] = (
                DebitNote.objects
                .filter(created_at__year=year, company=company)
                .aggregate(total_debit=Sum('grandtotal'))['total_debit'] or 0
            )

        monthly_debit_labels = [f"{month_names[month - 1]} {current_year}" for month in range(1, 13)]
        monthly_debit = [monthly_debit_data[month] for month in range(1, 13)]

        yearly_debit_labels = [str(year) for year in range(2022, current_year + 1)]
        yearly_debit = [yearly_debit_data[year] for year in range(2022, current_year + 1)]

        # Prepare data for rendering
        purchase_chart_data = {'monthly_labels': monthly_purchase_labels, 'monthly_purchase': monthly_purchase,
                               'yearly_labels': yearly_purchase_labels, 'yearly_purchase': yearly_purchase}

        debit_chart_data = {'monthly_labels': monthly_debit_labels, 'monthly_debit': monthly_debit,
                            'yearly_labels': yearly_debit_labels, 'yearly_debit': yearly_debit}

        return render(request, 'purchase_graph.html', {'purchase_chart_data': purchase_chart_data,
                                                                  'debit_chart_data': debit_chart_data,
                                                                  'company': company, 'user': user})
    else:
        return render(request, 'purchase_graph.html')  # Redirect to login page if user is not authenticated
